name: Collect SBOMs by Repository

on:
  workflow_run:
    workflows: ["main.yml"]
    types: 
           - completed

jobs:
  collect:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests jq

      - name: Collect SBOM artifacts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          mkdir -p collected_sboms

          # Get the last 200 workflow runs of main.yml (adjust if needed)
          runs=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/$REPO/actions/workflows/main.yml/runs?per_page=400 | jq -r '.workflow_runs[] | "\(.id) \(.head_repository.full_name)"')

          echo "$runs" | while read run_id repo_name; do
            echo "Processing run $run_id for repo $repo_name"

            # Create a folder for this repo
            safe_repo_name=$(echo "$repo_name" | tr '/' '_')
            repo_folder="collected_sboms/$safe_repo_name"
            mkdir -p "$repo_folder"

            # Get artifacts for the workflow run
            artifacts=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              https://api.github.com/repos/$REPO/actions/runs/$run_id/artifacts | jq -r '.artifacts[] | "\(.id) \(.name)"')

            echo "$artifacts" | while read artifact_id artifact_name; do
              echo "Downloading artifact $artifact_name ($artifact_id) into $repo_folder"
              curl -s -L -H "Authorization: token $GITHUB_TOKEN" \
                -o temp.zip \
                https://api.github.com/repos/$REPO/actions/artifacts/$artifact_id/zip

              unzip -o temp.zip -d "$repo_folder"
              rm temp.zip
            done
          done

      - name: Upload consolidated SBOMs
        uses: actions/upload-artifact@v4
        with:
          name: all_sboms
          path: collected_sboms/
