name: Collect SBOMs by Repository

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["main.yml"]
    types:
      - completed

jobs:
  collect:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq unzip curl

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests jq

      - name: Wait for a few minutes (ensure all artifacts are available)
        run: |
          echo "Waiting 2 minutes to ensure all artifacts are fully uploaded..."
          sleep 120

      - name: Collect SBOM artifacts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          mkdir -p collected_sboms
          echo "Fetching workflow runs for main.yml"

          runs=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/$REPO/actions/workflows/main.yml/runs?per_page=400 \
            | jq -r '.workflow_runs[] | select(.status=="completed") | "\(.id) \(.head_repository.full_name)"')

          if [ -z "$runs" ]; then
            echo "âš ï¸ No completed runs found. Exiting."
            exit 0
          fi

          echo "$runs" | while read run_id repo_name; do
            [ -z "$run_id" ] && continue
            echo "ðŸ“¦ Processing run $run_id for $repo_name"

            safe_repo_name=$(echo "$repo_name" | tr '/' '_')
            repo_folder="collected_sboms/$safe_repo_name"
            mkdir -p "$repo_folder"

            artifacts=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              https://api.github.com/repos/$REPO/actions/runs/$run_id/artifacts \
              | jq -r '.artifacts[]? | "\(.id) \(.name)"')

            if [ -z "$artifacts" ]; then
              echo "âš ï¸ No artifacts for $repo_name"
              continue
            fi

            echo "$artifacts" | while read artifact_id artifact_name; do
              echo "â¬‡ï¸ Downloading $artifact_name from $repo_name"
              curl -s -L -H "Authorization: token $GITHUB_TOKEN" \
                -o temp.zip \
                https://api.github.com/repos/$REPO/actions/artifacts/$artifact_id/zip

              unzip -o temp.zip -d "$repo_folder" >/dev/null
              rm temp.zip
            done
          done

      - name: Upload consolidated SBOMs
        uses: actions/upload-artifact@v4
        with:
          name: all_sboms
          path: collected_sboms/
