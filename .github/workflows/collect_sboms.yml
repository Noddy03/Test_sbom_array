name: Collect SBOMs Automatically

on:
  workflow_run:
    workflows: ["Conan + Trivy Full SBOM Scan"]  # Must match workflow name
    types:
      - completed

jobs:
  collect:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # CHECKOUT
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------
      # INSTALL DEPENDENCIES
      # -----------------------------
      - name: Install required tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq unzip curl python3-pip
          python3 -m pip install --upgrade pip
          pip install requests

      # -----------------------------
      # COLLECT ARTIFACTS
      # -----------------------------
      - name: Collect SBOM artifacts
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_TOKEN }}  # Must have repo + workflow scopes
          REPO: ${{ github.repository }}
        run: |
          mkdir -p collected_sboms

          echo "Fetching latest workflow runs..."
          runs=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/$REPO/actions/workflows/main.yml/runs?per_page=100 \
            | jq -r '.workflow_runs[] | "\(.id) \(.head_repository.full_name)"')

          echo "$runs" | while read run_id repo_name; do
            echo "Processing workflow run $run_id for repository $repo_name"

            safe_repo_name=$(echo "$repo_name" | tr '/' '_')
            repo_folder="collected_sboms/$safe_repo_name"
            mkdir -p "$repo_folder"

            artifacts=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              https://api.github.com/repos/$REPO/actions/runs/$run_id/artifacts \
              | jq -r '.artifacts[]? | "\(.id) \(.name)"')

            if [ -z "$artifacts" ]; then
              echo "No artifacts found for run $run_id"
              continue
            fi

            echo "$artifacts" | while read artifact_id artifact_name; do
              echo "Downloading artifact $artifact_name ($artifact_id) into $repo_folder"
              curl -s -L -H "Authorization: token $GITHUB_TOKEN" \
                -o temp.zip \
                https://api.github.com/repos/$REPO/actions/artifacts/$artifact_id/zip

              unzip -o temp.zip -d "$repo_folder"
              rm temp.zip
            done
          done

      # -----------------------------
      # UPLOAD CONSOLIDATED ARTIFACT
      # -----------------------------
      - name: Upload all SBOMs
        uses: actions/upload-artifact@v4
        with:
          name: all_sboms
          path: collected_sboms/
