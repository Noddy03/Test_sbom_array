name: IoT SBOM + Dual SCA Scan

on:
  workflow_dispatch:
    inputs:
      language:
        description: 'Programming language (e.g., Java, Python)'
        required: true
        default: 'Java'
      max_repos:
        description: 'Number of top-starred IoT repos to scan'
        required: true
        default: '20'

jobs:
  fetch-repos:
    runs-on: ubuntu-latest
    outputs:
      repo_list: ${{ steps.set_output.outputs.repo_list }}
    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq curl git

      - name: Fetch Top IoT Repositories
        id: set_output
        run: |
          LANGUAGE="${{ github.event.inputs.language }}"
          MAX="${{ github.event.inputs.max_repos }}"
          RESPONSE=$(curl -s -H "Authorization: Bearer ${{ github.token }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/search/repositories?q=topic:iot+language:$LANGUAGE&sort=stars&order=desc&per_page=$MAX")

          echo "$RESPONSE" | jq -r '.items[].clone_url' > repos.txt
          jq -R -s -c 'split("\n")[:-1]' repos.txt > repos.json

          # Use environment file instead of set-output
          echo "repo_list=$(cat repos.json)" >> $GITHUB_OUTPUT
          echo "Fetched $(wc -l < repos.txt) repos."

  scan-and-generate:
    needs: fetch-repos
    runs-on: ubuntu-latest
    timeout-minutes: 180
    steps:
      - name: Install tools
        run: |
          sudo apt-get update && sudo apt-get install -y jq git curl
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin

      - name: Prepare output folder
        run: mkdir -p output

      - name: Loop over repos and generate SBOM + dual SCA
        run: |
          SUMMARY_FILE=output/summary.csv
          echo "repo,dependencies,sca_direct,sca_from_sbom,status" > "$SUMMARY_FILE"

          for repo in $(echo '${{ needs.fetch-repos.outputs.repo_list }}' | jq -r '.[]'); do
            echo "Processing $repo"
            name=$(basename "$repo" .git)

            # Clone repo (20 min timeout)
            if ! timeout 1200 git clone --depth 1 "$repo" "$name"; then
              echo "Timeout cloning $repo. Skipping..."
              echo "$name,0,0,0,clone_timeout" >> "$SUMMARY_FILE"
              continue
            fi

            cd "$name"

            # Generate SBOM (20 min timeout)
            if ! timeout 1200 syft . -o cyclonedx-json > ../output/${name}_sbom.json; then
              echo "Timeout SBOM for $repo"
              echo "$name,0,0,0,sbom_timeout" >> ../output/summary.csv
              cd ..
              rm -rf "$name"
              continue
            fi

            # Count dependencies from SBOM
            deps=$(jq '.artifacts | length' ../output/${name}_sbom.json 2>/dev/null || echo 0)

            # Direct SCA (20 min timeout)
            if timeout 1200 grype . -o json > ../output/${name}_sca_direct.json; then
              direct=$(jq '.matches | length' ../output/${name}_sca_direct.json 2>/dev/null || echo 0)
            else
              echo "Timeout direct SCA for $repo"
              direct=0
            fi

            # SCA from SBOM (20 min timeout)
            if timeout 1200 grype sbom:../output/${name}_sbom.json -o json > ../output/${name}_sca_from_sbom.json; then
              from_sbom=$(jq '.matches | length' ../output/${name}_sca_from_sbom.json 2>/dev/null || echo 0)
            else
              echo "Timeout SCA from SBOM for $repo"
              from_sbom=0
            fi

            # Append to summary
            echo "$name,$deps,$direct,$from_sbom,success" >> ../output/summary.csv

            cd ..
            rm -rf "$name"
          done

      - name: Upload SBOM + SCA artifacts and summary
        uses: actions/upload-artifact@v4
        with:
          name: iot-sbom-sca
          path: output/
