name: IoT SBOM + SCA scan (Trivy)

on:
  workflow_dispatch:
    inputs:
      language:
        description: 'Programming language (e.g., Python, C, Go)'
        required: true
        default: 'Python'
      max_repos:
        description: 'Top-starred IoT repos to scan'
        required: true
        default: '20'

jobs:
  fetch-repos:
    runs-on: ubuntu-latest
    outputs:
      repo_list: ${{ steps.fetch.outputs.repo_list }}

    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Search Top IoT Repos
        id: fetch_repos
        run: |
            LANGUAGE="${{ github.event.inputs.language }}"
            RESPONSE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/search/repositories?q=topic:iot+language:$LANGUAGE&sort=stars&order=desc&per_page=100")

            if echo "$RESPONSE" | jq -e 'has("items")' >/dev/null; then
              echo "$RESPONSE" | jq -r '.items | .[]?.clone_url' > repos.txt
            else
              echo "⚠️ GitHub API returned no .items; likely rate-limit or error:"
              echo "$RESPONSE"
              exit   1
            fi

            echo "Fetched $(wc -l < repos.txt) repos."

  scan:
    needs: fetch-repos
    runs-on: ubuntu-latest
    strategy:
      matrix:
        repo: ${{ fromJson(needs.fetch-repos.outputs.repo_list) }}
      fail-fast: false
    timeout-minutes: 30

    steps:
      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
            | sudo sh -s -- -b /usr/local/bin

      - name: Clone repository
        run: |
          REPO="${{ matrix.repo }}"
          NAME=$(basename "$REPO" .git)

          echo "Cloning $REPO"
          if ! timeout 1200 git clone --depth 1 "$REPO" "$NAME"; then
            echo "clone_timeout" > clone_error.txt
            exit 0
          fi

      - name: Run SBOM + SCA scans
        run: |
          NAME=$(basename "${{ matrix.repo }}" .git)
          mkdir -p output
          cd "$NAME"

          echo "Generating SBOM..."
          timeout 1200 trivy sbom \
            --format cyclonedx-json \
            --output ../output/"${NAME}_sbom.json" .

          echo "Running SCA (direct)..."
          timeout 1200 trivy fs \
            --security-checks vuln \
            --format json \
            --output ../output/"${NAME}_sca_direct.json" .

          echo "Running SCA (from SBOM)..."
          timeout 1200 trivy sbom \
            --input ../output/"${NAME}_sbom.json" \
            --format json \
            --output ../output/"${NAME}_sca_from_sbom.json"

          sbom_count=$(jq '.components | length' ../output/"${NAME}_sbom.json" 2>/dev/null || echo 0)
          direct_vuln=$(jq '[.Results[].Vulnerabilities[]?] | length' ../output/"${NAME}_sca_direct.json" 2>/dev/null || echo 0)
          sbom_vuln=$(jq '[.Results[].Vulnerabilities[]?] | length' ../output/"${NAME}_sca_from_sbom.json" 2>/dev/null || echo 0)

          echo "$NAME,$sbom_count,$direct_vuln,$sbom_vuln" > ../output/"${NAME}_summary.csv"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.repo }}-sbom-sca
          path: output/
