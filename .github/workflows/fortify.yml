name: IoT SBOM + SCA scan (Trivy)

on:
  workflow_dispatch:
    inputs:
      language:
        description: 'Programming language (e.g., Python, Java, C++)'
        required: true
        default: 'Python'
      max_repos:
        description: 'Number of top-starred IoT repos to scan'
        required: true
        default: '20'

jobs:
  fetch-repos:
    runs-on: ubuntu-latest
    outputs:
      repo_list: ${{ steps.fetch.outputs.repo_list }}

    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch Top IoT Repositories
        id: fetch
        run: |
          LANGUAGE="${{ github.event.inputs.language }}"
          MAX="${{ github.event.inputs.max_repos }}"

          RESPONSE=$(curl -s \
            -H "Authorization: Bearer ${{ github.token }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/search/repositories?q=topic:iot+language:$LANGUAGE&sort=stars&order=desc&per_page=$MAX")

          if echo "$RESPONSE" | jq -e 'has("items")' >/dev/null; then
            echo "$RESPONSE" | jq -r '.items | .[]?.clone_url' > repos.txt
          else
            echo "⚠️ GitHub API returned no .items; check rate limit or query:"
            echo "$RESPONSE"
            exit 1
          fi

          jq -R -s -c 'split("\n")[:-1]' repos.txt > repos.json
          echo "::set-output name=repo_list::$(cat repos.json)"
          echo "Fetched $(wc -l < repos.txt) repos."

  scan:
    needs: fetch-repos
    runs-on: ubuntu-latest
    strategy:
      matrix:
        repo: ${{ fromJson(needs.fetch-repos.outputs.repo_list) }}
      fail-fast: false
    timeout-minutes: 40  # increase for large repos

    steps:
      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
            | sudo sh -s -- -b /usr/local/bin

      - name: Clone repository
        run: |
          REPO="${{ matrix.repo }}"
          NAME=$(basename "$REPO" .git)
          echo "Cloning $REPO"
          if ! timeout 1800 git clone --depth 1 "$REPO" "$NAME"; then
            echo "clone_timeout" > clone_error.txt
            exit 0
          fi

      - name: Set sanitized artifact name
        id: artifact_name
        run: |
          REPO_NAME=$(basename "${{ matrix.repo }}" .git)
          SAFE_NAME=${REPO_NAME//[^a-zA-Z0-9_-]/_}
          echo "::set-output name=name::$SAFE_NAME"

      - name: Generate SBOM + SCA scans
        run: |
          NAME=$(basename "${{ matrix.repo }}" .git)
          SAFE_NAME=${{ steps.artifact_name.outputs.name }}
          mkdir -p output
          cd "$NAME"

          # -------------------------
          # 1️⃣ Generate SBOM (robust)
          # -------------------------
          echo "Generating SBOM..."
          if timeout 1200 trivy sbom --scanners vuln --format cyclonedx --output ../output/"${SAFE_NAME}_sbom.json" .; then
            SBOM_OK=1
          else
            echo "⚠️ SBOM scan failed for $NAME"
            SBOM_OK=0
            echo '{}' > ../output/"${SAFE_NAME}_sbom.json"
          fi

          # -------------------------
          # 2️⃣ Direct SCA (robust)
          # -------------------------
          echo "Running SCA (direct)..."
          timeout 1800 trivy fs --scanners vuln --format json --output ../output/"${SAFE_NAME}_sca_direct.json" . || echo "⚠️ Direct SCA failed for $NAME"

          # -------------------------
          # 3️⃣ SCA from SBOM (only if SBOM succeeded)
          # -------------------------
          if [ "$SBOM_OK" -eq 1 ]; then
            echo "Running SCA (from SBOM)..."
            timeout 1200 trivy sbom --input ../output/"${SAFE_NAME}_sbom.json" --format json --output ../output/"${SAFE_NAME}_sca_from_sbom.json" || echo "⚠️ SCA from SBOM failed for $NAME"
          else
            echo '{}' > ../output/"${SAFE_NAME}_sca_from_sbom.json"
          fi

          # -------------------------
          # 4️⃣ Generate summary CSV
          # -------------------------
          sbom_count=0
          if [ "$SBOM_OK" -eq 1 ]; then
            sbom_count=$(jq '.components | length' ../output/"${SAFE_NAME}_sbom.json" 2>/dev/null || echo 0)
          fi
          direct_vuln=$(jq '[.Results[].Vulnerabilities[]?] | length' ../output/"${SAFE_NAME}_sca_direct.json" 2>/dev/null || echo 0)
          sbom_vuln=$(jq '[.Results[].Vulnerabilities[]?] | length' ../output/"${SAFE_NAME}_sca_from_sbom.json" 2>/dev/null || echo 0)

          echo "$SAFE_NAME,$sbom_count,$direct_vuln,$sbom_vuln" > ../output/"${SAFE_NAME}_summary.csv"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifact_name.outputs.name }}-sbom-sca
          path: output/

  aggregate-summary:
    needs: scan
    runs-on: ubuntu-latest
    steps:
      - name: Download all per-repo artifacts
        uses: actions/download-artifact@v4
        with:
          path: all_outputs

      - name: Combine summaries into master_summary.csv
        run: |
          mkdir -p master
          echo "repo,sbom_components,direct_vulnerabilities,sbom_vulnerabilities" > master/master_summary.csv

          # Append all per-repo CSVs (skip headers)
          for f in $(find all_outputs -name "*_summary.csv"); do
            tail -n +2 "$f" >> master/master_summary.csv
          done

      - name: Upload master_summary.csv
        uses: actions/upload-artifact@v4
        with:
          name: master_summary
          path: master/master_summary.csv
