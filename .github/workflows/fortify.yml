name: IoT Repo Scanner

on:
  workflow_dispatch:
    inputs:
      language:
        description: "Language to filter repositories by"
        required: true
        default: "Java"

jobs:

  fetch-repos:
    runs-on: ubuntu-latest
    outputs:
      repo_count: ${{ steps.count.outputs.repo_count }}
    steps:
      - name: Fetch IoT Repositories
        id: fetch
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          LANGUAGE="${{ github.event.inputs.language }}"
          echo "Fetching repos for language=$LANGUAGE"
          
          curl -s \
            -H "Authorization: Bearer $GH_TOKEN" \
            "https://api.github.com/search/repositories?q=topic:iot+language:$LANGUAGE&sort=stars&order=desc&per_page=100" \
            | jq -r '.items[].clone_url' > repos.txt

          echo "Fetched $(wc -l < repos.txt) repos"
          
      - name: Count repos
        id: count
        run: |
          echo "repo_count=$(wc -l < repos.txt)" >> $GITHUB_OUTPUT

      - name: Upload repo list
        uses: actions/upload-artifact@v4
        with:
          name: repo-list
          path: repos.txt


  scan-all:
    needs: fetch-repos
    runs-on: ubuntu-latest
    timeout-minutes: 300
    steps:

      - name: Download repo list
        uses: actions/download-artifact@v4
        with:
          name: repo-list

      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
            | sudo sh -s -- -b /usr/local/bin

      - name: Install Trivy SBOM Plugins
        run: |
          trivy plugin install cyclonedx
          trivy plugin install spdx

      - name: Prepare output directory
        run: |
          mkdir -p output
          echo "repo,sbom_deps,sca_issues,sbom_sca_issues,status" > output/summary.csv

      - name: Scan Each Repo
        run: |
          while read repo; do
            echo "======== SCANNING $repo ========"

            name=$(basename $repo .git)
            safe_name=${name//[^A-Za-z0-9._-]/_}

            # Clone
            if ! timeout 1200 git clone --depth 1 "$repo" "$safe_name"; then
              echo "$safe_name,0,0,0,clone_failed" >> output/summary.csv
              continue
            fi

            cd "$safe_name"

            # SBOM Generation (CycloneDX)
            if timeout 1200 trivy sbom --format cyclonedx --output "../output/${safe_name}_sbom.json" .; then
              sbom_deps=$(jq '.components | length' "../output/${safe_name}_sbom.json" 2>/dev/null || echo 0)
            else
              echo "SBOM FAILED for $name"
              sbom_deps=0
            fi

            # Direct Vulnerability Scan
            if timeout 1200 trivy fs --format json --output "../output/${safe_name}_sca_direct.json" .; then
              sca_issues=$(jq '.Results[].Vulnerabilities | length' "../output/${safe_name}_sca_direct.json" 2>/dev/null | paste -sd+ - | bc || echo 0)
            else
              echo "SCA FAILED for $name"
              sca_issues=0
            fi

            # SCA from SBOM
            if [ -f "../output/${safe_name}_sbom.json" ]; then
              if timeout 1200 trivy sbom --input "../output/${safe_name}_sbom.json" --format json \
                 --output "../output/${safe_name}_sca_from_sbom.json"; then
                sbom_sca=$(jq '.Results[].Vulnerabilities | length' "../output/${safe_name}_sca_from_sbom.json" 2>/dev/null | paste -sd+ - | bc || echo 0)
              else
                sbom_sca=0
              fi
            else
              sbom_sca=0
            fi

            echo "$safe_name,$sbom_deps,$sca_issues,$sbom_sca,success" >> ../output/summary.csv

            cd ..
            rm -rf "$safe_name"

          done < repos.txt

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: full-iot-scan
          path: output/
