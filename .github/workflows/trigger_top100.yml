name: Fetch, Trigger & Collect SBOM Scans

on:
  workflow_dispatch:

permissions:
  contents: read
  actions: read

jobs:
  fetch_trigger_collect:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # INSTALL DEPENDENCIES
      # -----------------------------
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq gh curl

      # -----------------------------
      # SET GH CLI TOKEN (PAT)
      # -----------------------------
      - name: Set GH CLI authentication
        run: echo "GH_TOKEN=${{ secrets.PERSONAL_TOKEN }}" >> $GITHUB_ENV

      # -----------------------------
      # FETCH TOP PUBLIC C++ REPOS
      # -----------------------------
      - name: Fetch top 100 public C++ repositories
        run: |
          LANGUAGE="C++"
          mkdir -p output
          curl -s -H "Accept: application/vnd.github+json" \
            "https://api.github.com/search/repositories?q=language:${LANGUAGE}&sort=stars&order=desc&per_page=100" \
            | jq '[.items[] | select(.private == false) | .full_name]' > output/top_public_repos.json

      # -----------------------------
      # Upload repo list artifact
      # -----------------------------
      - name: Upload repository list
        uses: actions/upload-artifact@v4
        with:
          name: top-repos
          path: output/top_public_repos.json

      # -----------------------------
      # LOAD REPOS INTO ARRAY SAFELY
      # -----------------------------
      - name: Load repos into array
        id: load_repos
        run: |
          mapfile -t repos_array < <(jq -r '.[]' output/top_public_repos.json)
          echo "repos_array=${repos_array[*]}" >> $GITHUB_ENV
          echo "Loaded ${#repos_array[@]} repositories"

      # -----------------------------
      # TRIGGER MAIN WORKFLOW FOR EACH REPO
      # -----------------------------
      - name: Trigger Conan + Trivy SBOM workflow
        run: |
          for repo in "${repos_array[@]}"; do
            echo "Triggering SBOM scan for $repo..."

            run_number=$(gh workflow run "Conan + Trivy Full SBOM Scan" \
              --ref main \
              -f src_repository="$repo" \
              -f src_branch="main" \
              -f src_type="c++" \
              -f conan_repository="Noddy03/Conan_Trivy_full_SBOM_scan" \
              -f conan_branch="main" \
              --json number \
              | jq -r '.number')

            if [[ -n "$run_number" ]]; then
              echo "Workflow triggered for $repo, run number: $run_number"
            else
              echo "Failed to trigger workflow for $repo"
            fi

            # Optional: throttle to avoid API limits
            sleep 2
          done
