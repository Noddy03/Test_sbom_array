name: Fetch, Scan, and Collect SBOMs (Automated)

on:
  workflow_dispatch:
    inputs:
      language:
        description: "Language to fetch repositories for"
        required: true
        default: "C++"

jobs:
  # -----------------------------------------------------
  # FETCH TOP 100 REPOSITORIES
  # -----------------------------------------------------
  fetch:
    runs-on: ubuntu-latest
    outputs:
      repo_list: ${{ steps.collect.outputs.repo_list }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests jq

      - name: Fetch Top 100 Repositories
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          LANGUAGE: ${{ github.event.inputs.language }}
        run: |
          python scripts/fetch_top_repos.py

      - id: collect
        run: |
          repos=$(cat output/top_repos.json | jq -c '.')
          echo "repo_list=$repos" >> $GITHUB_OUTPUT

  # -----------------------------------------------------
  # TRIGGER MAIN SCAN WORKFLOW FOR EACH REPO
  # -----------------------------------------------------
  trigger:
    needs: fetch
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        repo: ${{ fromJson(needs.fetch.outputs.repo_list) }}

    steps:
      - name: Trigger Conan+Trivy Workflow
        id: trigger_workflow
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: main.yml
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main
          inputs: >-
            {
              "src_repository": "${{ matrix.repo }}",
              "src_branch": "main",
              "conan_repository": "Noddy03/Conan_Trivy_full_SBOM_scan",
              "conan_branch": "main",
              "src_type": "${{ github.event.inputs.language }}"
            }

      - name: Log triggered repository
        run: echo "âœ… Triggered scan for repository: ${{ matrix.repo }}"

  # -----------------------------------------------------
  # WAIT UNTIL ALL main.yml RUNS ARE COMPLETE, THEN COLLECT
  # -----------------------------------------------------
  finalize:
    needs: trigger
    runs-on: ubuntu-latest
    steps:
      - name: Wait for all main.yml runs to complete
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          echo "ðŸ•’ Waiting for all main.yml runs to complete..."
          while true; do
            in_progress=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              https://api.github.com/repos/$REPO/actions/workflows/main.yml/runs?per_page=400 \
              | jq '[.workflow_runs[] | select(.status != "completed")] | length')

            echo "Still $in_progress runs in progress..."
            if [ "$in_progress" -eq 0 ]; then
              echo "âœ… All runs completed!"
              break
            fi

            echo "Sleeping 5 minutes before checking again..."
            sleep 300
          done

      - name: Trigger collector workflow
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: collect_sboms.yml
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main
