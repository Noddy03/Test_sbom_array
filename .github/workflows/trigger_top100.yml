name: Fetch, Trigger & Collect SBOM Scans

on:
  workflow_dispatch:

permissions:
  contents: read
  actions: read

jobs:
  fetch_trigger_collect:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # INSTALL DEPENDENCIES
      # -----------------------------
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq gh curl

      # -----------------------------
      # SET GH CLI TOKEN (PAT)
      # -----------------------------
      - name: Set GH CLI authentication
        run: echo "GH_TOKEN=${{ secrets.PERSONAL_TOKEN }}" >> $GITHUB_ENV

      # -----------------------------
      # FETCH TOP PUBLIC C++ REPOS
      # -----------------------------
      - name: Fetch top 100 public C++ repositories
        run: |
          LANGUAGE="C++"
          mkdir -p output
          curl -s -H "Accept: application/vnd.github+json" \
            "https://api.github.com/search/repositories?q=language:${LANGUAGE}&sort=stars&order=desc&per_page=100" \
            | jq '[.items[] | select(.private == false) | .full_name]' > output/top_public_repos.json

      # -----------------------------
      # Upload repo list artifact
      # -----------------------------
      - name: Upload repository list
        uses: actions/upload-artifact@v4
        with:
          name: top-repos
          path: output/top_public_repos.json

      # -----------------------------
      # SAVE REPOS TO FILE
      # -----------------------------
      - name: Save repos to file
        run: |
          mkdir -p output
          jq -r '.[]' output/top_public_repos.json > output/repos_list.txt
          echo "Saved $(wc -l < output/repos_list.txt) repositories to file."

      # -----------------------------
      # TRIGGER WORKFLOW AND COLLECT ARTIFACTS
      # -----------------------------
      - name: Trigger SBOM workflow and collect artifacts
        run: |
          mkdir -p collected-artifacts
          WORKFLOW_REPO="Noddy03/Conan_Trivy_full_SBOM_scan"
          WORKFLOW_NAME="Conan + Trivy Full SBOM Scan"

          while IFS= read -r repo; do
            echo "Triggering SBOM scan for $repo..."

            run_info=$(gh workflow run "$WORKFLOW_NAME" \
              --repo "$WORKFLOW_REPO" \
              --ref main \
              -f src_repository="$repo" \
              -f src_branch="main" \
              -f src_type="c++" \
              -f conan_repository="$WORKFLOW_REPO" \
              -f conan_branch="main" \
              --json id,html_url)

            run_id=$(echo "$run_info" | jq -r '.id')
            run_url=$(echo "$run_info" | jq -r '.html_url')

            if [[ -z "$run_id" || "$run_id" == "null" ]]; then
              echo "âŒ Failed to trigger workflow for $repo"
              echo "Response: $run_info"
              continue
            fi

            echo "âœ… Workflow triggered for $repo, run ID: $run_id"
            echo "View run: $run_url"

            # Wait for workflow to complete
            echo "â³ Waiting for workflow $run_id to finish..."
            gh run watch "$run_id"

            # Download workflow artifacts
            echo "ðŸ“¥ Downloading artifacts for $repo..."
            gh run download "$run_id" --dir "collected-artifacts/$repo"

            # Optional: throttle to avoid API limits
            sleep 2

          done < output/repos_list.txt

      # -----------------------------
      # Upload all collected SBOM artifacts
      # -----------------------------
      - name: Upload collected SBOM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: all-sbom-reports
          path: collected-artifacts
          if-no-files-found: warn
