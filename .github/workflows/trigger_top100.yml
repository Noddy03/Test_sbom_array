name: Fetch, Trigger & Collect SBOM Scans

on:
  workflow_dispatch:

permissions:
  contents: read
  actions: read

jobs:
  fetch_trigger_collect:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.SBOM_TOKEN_PERSONAL }}

    steps:
      # -----------------------------
      # INSTALL DEPENDENCIES
      # -----------------------------
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq gh curl

      # -----------------------------
      # FETCH TOP PUBLIC C++ REPOS
      # -----------------------------
      - name: Fetch top 100 public C++ repositories
        run: |
          LANGUAGE="C++"
          mkdir -p output
          curl -s -H "Accept: application/vnd.github+json" \
            "https://api.github.com/search/repositories?q=language:${LANGUAGE}&sort=stars&order=desc&per_page=100" \
            | jq '[.items[] | select(.private == false) | .full_name]' > output/top_public_repos.json

      # -----------------------------
      # Upload repo list artifact
      # -----------------------------
      - name: Upload repository list
        uses: actions/upload-artifact@v4
        with:
          name: top-repos
          path: output/top_public_repos.json

      # -----------------------------
      # Load repos into array safely
      # -----------------------------
      - name: Load repos into array
        id: load_repos
        run: |
          mapfile -t repos_array < <(jq -r '.[]' output/top_public_repos.json)
          echo "Loaded ${#repos_array[@]} repositories"
          # Export repos as environment variable for next step
          echo "REPOS_ARRAY=${repos_array[*]}" >> $GITHUB_ENV

      # -----------------------------
      # Trigger workflow and collect artifacts
      # -----------------------------
      - name: Trigger SBOM workflow and collect artifacts
        run: |
          mkdir -p collected-artifacts
          WORKFLOW_REPO="Noddy03/Conan_Trivy_full_SBOM_scan"
          WORKFLOW_NAME="Conan + Trivy Full SBOM Scan"

          # Convert REPOS_ARRAY string to Bash array
          IFS=' ' read -r -a repos_array <<< "$REPOS_ARRAY"

          for repo in "${repos_array[@]}"; do
            echo "Triggering SBOM scan for $repo..."

            # Prepare JSON input
            json_input=$(jq -n \
              --arg src_repo "$repo" \
              --arg src_branch "main" \
              --arg src_type "c++" \
              --arg conan_repo "$WORKFLOW_REPO" \
              --arg conan_branch "main" \
              '{src_repository: $src_repo, src_branch: $src_branch, src_type: $src_type, conan_repository: $conan_repo, conan_branch: $conan_branch}')

            # Trigger workflow using stdin JSON
            run_id=$(echo "$json_input" | gh workflow run "$WORKFLOW_NAME" \
              --repo "$WORKFLOW_REPO" \
              --ref main \
              --json | jq -r '.id')

            if [[ -z "$run_id" || "$run_id" == "null" ]]; then
              echo "Failed to trigger workflow for $repo"
              continue
            fi

            echo "Workflow triggered for $repo, run ID: $run_id"

            # Wait for workflow to complete
            gh run watch "$run_id" --repo "$WORKFLOW_REPO"

            # Download workflow artifacts
            echo "Downloading artifacts for $repo..."
            gh run download "$run_id" --repo "$WORKFLOW_REPO" --dir "collected-artifacts/$repo"
            sleep 2
          done

      # -----------------------------
      # Upload all collected SBOM artifacts
      # -----------------------------
      - name: Upload collected SBOM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: all-sbom-reports
          path: collected-artifacts
          if-no-files-found: warn
