name: Fetch & Trigger SBOM Scans

on:
  workflow_dispatch:

jobs:
  fetch_and_trigger:
    runs-on: ubuntu-latest
    permissions:
        actions: read
        contents: read
       

    steps:
      # -----------------------------
      # SETUP ENVIRONMENT
      # -----------------------------
      - name: Setup jq & gh CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y jq gh curl

      # -----------------------------
      # FETCH TOP PUBLIC C++ REPOS
      # -----------------------------
      - name: Fetch top 100 public C++ repositories
        run: |
          LANGUAGE="C++"
          mkdir -p output
          curl -s -H "Accept: application/vnd.github+json" \
            "https://api.github.com/search/repositories?q=language:${LANGUAGE}&sort=stars&order=desc&per_page=100" \
            | jq '[.items[] | select(.private == false) | .full_name]' > output/top_public_repos.json

      # -----------------------------
      # LOAD REPOS INTO ARRAY
      # -----------------------------
      - name: Load repos into array
        id: load_repos
        run: |
          repos_array=($(jq -r '.[]' output/top_public_repos.json))
          echo "repos_array=${repos_array[*]}" >> $GITHUB_ENV

      # -----------------------------
      # TRIGGER SBOM WORKFLOW FOR EACH REPO
      # -----------------------------
      - name: Trigger SBOM workflow for each repo
        run: |
          for repo in $repos_array; do
            echo "Triggering SBOM scan for $repo..."
            run_id=$(gh workflow run "Conan + Trivy Full SBOM Scan" \
              --ref main \
              -f src_repository="$repo" \
              -f src_branch="main" \
              -f src_type="c++" \
              --json number | jq -r '.number')
            echo "Workflow triggered, run ID: $run_id"
          done
