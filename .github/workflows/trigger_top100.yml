name: Fetch, Trigger & Collect SBOM Scans

on:
  workflow_dispatch:

permissions:
  contents: read
  actions: read

jobs:
  fetch_trigger_collect:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # INSTALL DEPENDENCIES
      # -----------------------------
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq gh curl

      # -----------------------------
      # SET GH CLI TOKEN (PAT)
      # -----------------------------
      - name: Set GH CLI authentication
        run: echo "GH_TOKEN=${{ secrets.PERSONAL_TOKEN }}" >> $GITHUB_ENV

      # -----------------------------
      # FETCH TOP PUBLIC C++ REPOS
      # -----------------------------
      - name: Fetch top 100 public C++ repositories
        run: |
          LANGUAGE="C++"
          mkdir -p output
          curl -s -H "Accept: application/vnd.github+json" \
            "https://api.github.com/search/repositories?q=language:${LANGUAGE}&sort=stars&order=desc&per_page=100" \
            | jq '[.items[] | select(.private == false) | .full_name]' > output/top_public_repos.json

      # -----------------------------
      # Upload repo list artifact
      # -----------------------------
      - name: Upload repository list
        uses: actions/upload-artifact@v4
        with:
          name: top-repos
          path: output/top_public_repos.json

      # -----------------------------
      # LOAD REPOS INTO ARRAY SAFELY
      # -----------------------------
      - name: Load repos into array
        id: load_repos
        run: |
          mapfile -t repos_array < <(jq -r '.[]' output/top_public_repos.json)
          echo "repos_array=${repos_array[*]}" >> $GITHUB_ENV
          echo "Loaded ${#repos_array[@]} repositories"

      # -----------------------------
      # TRIGGER WORKFLOW AND WAIT FOR COMPLETION
      # -----------------------------
      - name: Trigger SBOM workflow and collect artifacts
        run: |
          mkdir -p collected-artifacts
          for repo in "${repos_array[@]}"; do
            echo "Triggering SBOM scan for $repo..."

            # Trigger workflow
            run_id=$(gh workflow run "Conan + Trivy Full SBOM Scan" \
              --ref main \
              -f src_repository="$repo" \
              -f src_branch="main" \
              -f src_type="c++" \
              -f conan_repository="Noddy03/Conan_Trivy_full_SBOM_scan" \
              -f conan_branch="main" \
              --json id \
              | jq -r '.id')

            if [[ -z "$run_id" ]]; then
              echo "Failed to trigger workflow for $repo"
              continue
            fi

            echo "Workflow triggered for $repo, run ID: $run_id"

            # Wait for workflow to complete
            echo "Waiting for workflow $run_id to finish..."
            gh run watch "$run_id"

            # Download workflow artifacts
            echo "Downloading artifacts for $repo..."
            gh run download "$run_id" --dir "collected-artifacts/$repo"
            
            # Optional: throttle to avoid API limits
            sleep 2
          done

      # -----------------------------
      # Upload all collected SBOM artifacts
      # -----------------------------
      - name: Upload collected SBOM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: all-sbom-reports
          path: collected-artifacts
