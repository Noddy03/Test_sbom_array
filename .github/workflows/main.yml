name: Fetch IoT Repos + SBOM Pipeline (Conan + Trivy + GitHub Licenses)

on:
  workflow_dispatch:
    inputs:
      language:
        description: "Programming language to scan (C++, Python, Java, etc.)"
        required: true
        default: "C++"

permissions:
  contents: read
  security-events: write
  actions: read

jobs:

  # ------------------------------------------------------------------
  # 1. Fetch IoT repositories by language using GH API
  # ------------------------------------------------------------------
  fetch_repos:
    runs-on: ubuntu-latest

    outputs:
      repo_list: ${{ steps.collect.outputs.repo_list }}

    steps:
      - name: Install GitHub CLI
        run: sudo apt-get update && sudo apt-get install -y gh jq

      - name: Authenticate GH CLI
        run: echo "${{ github.token }}" | gh auth login --with-token

      - name: Search IoT repos in selected language
        id: collect
        run: |
          RAW_Q="topic:IoT language:\"${{ inputs.language }}\" fork:false archived:false"

          gh search repos "$RAW_Q" --limit 20 --json fullName \
            | jq -r '.[].fullName' > repos.txt

          REPO_JSON=$(jq -Rn '[inputs | select(length>0)]' repos.txt)
          echo "repo_list=$REPO_JSON" >> $GITHUB_OUTPUT

      - name: Show repo list
        run: cat repos.txt


  # ------------------------------------------------------------------
  # 2. SBOM + License Scan for each repository
  # ------------------------------------------------------------------
  sbom_scan:
    needs: fetch_repos
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        repo: ${{ fromJson(needs.fetch_repos.outputs.repo_list) }}

    steps:

      - name: Install tools (Git, Conan, Trivy, jq)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y git jq python3-pip
          pip install conan
          sudo apt-get install -y trivy

      - name: Clone repository
        run: |
          git clone "https://github.com/${{ matrix.repo }}" project
          cd project
          echo "cloned ${{ matrix.repo }}"

      # ----------------------------------------
      # Conan SBOM
      # ----------------------------------------
      - name: Generate Conan SBOM
        working-directory: project
        continue-on-error: true
        run: |
          conan profile detect || true
          conan install . --build=missing || true
          conan sbom --format cyclonedx-json > ../conan-sbom.json || echo "{}" > ../conan-sbom.json

      # ----------------------------------------
      # Trivy SBOM FS scan
      # ----------------------------------------
      - name: Generate Trivy SBOM (filesystem)
        run: |
          trivy fs project --format cyclonedx --output trivy-fs.json || echo "{}" > trivy-fs.json

      # ----------------------------------------
      # Fetch GitHub License Metadata
      # ----------------------------------------
      - name: Fetch repository license via GitHub API
        run: |
          OWNER=$(echo "${{ matrix.repo }}" | cut -d'/' -f1)
          NAME=$(echo "${{ matrix.repo }}" | cut -d'/' -f2)

          curl -s \
            -H "Authorization: Bearer ${{ github.token }}" \
            "https://api.github.com/repos/$OWNER/$NAME/license" \
            | jq '{ license: .license }' > gh-license.json

      # ----------------------------------------
      # SBOMQS – NTIA / BSI / Score
      # ----------------------------------------
      - name: Run SBOMQS (NTIA)
        run: |
          docker run --rm -v $PWD:/sbom ghcr.io/interlynk-io/sbomqs:latest \
            compliance --ntia /sbom/trivy-fs.json \
            > compliance_NTIA.json || echo "{}" > compliance_NTIA.json

      - name: Run SBOMQS (BSI V2)
        run: |
          docker run --rm -v $PWD:/sbom ghcr.io/interlynk-io/sbomqs:latest \
            compliance --bsi-v2 /sbom/trivy-fs.json \
            > compliance_BSI.json || echo "{}" > compliance_BSI.json

      - name: Run SBOMQS Score
        run: |
          docker run --rm -v $PWD:/sbom ghcr.io/interlynk-io/sbomqs:latest \
            score /sbom/trivy-fs.json --json \
            > score.json || echo "{}" > score.json

      # ----------------------------------------
      # Upload SBOM + SBOMQS results
      # ----------------------------------------
      - name: Sanitize repo name
        run: |
          SAFE="${{ matrix.repo }}"
          SAFE="${SAFE//\//_}"
          echo "SAFE_NAME=$SAFE" >> $GITHUB_ENV

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: results-${{ env.SAFE_NAME }}
          path: |
            conan-sbom.json
            trivy-fs.json
            gh-license.json
            compliance_NTIA.json
            compliance_BSI.json
            score.json


  # ------------------------------------------------------------------
  # 3. Aggregate JSON results → CSV (NO PYTHON)
  # ------------------------------------------------------------------
  aggregate_results:
    needs: sbom_scan
    runs-on: ubuntu-latest

    steps:

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: results/

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Aggregate SBOMQS results (jq only, NO PYTHON)
        run: |
          echo "repository,type,key,value" > sbomqs_summary.csv

          find results -type f -name "*.json" | while read FILE; do
            REPO=$(echo "$FILE" | sed 's/.*results\/\(.*\)\/.*/\1/')

            TYPE="unknown"
            case "$FILE" in
              *score.json) TYPE="score" ;;
              *NTIA.json)  TYPE="NTIA" ;;
              *BSI.json)   TYPE="BSI" ;;
              *gh-license.json) TYPE="license" ;;
              *conan-sbom.json) TYPE="conan-sbom" ;;
              *trivy-fs.json) TYPE="trivy-sbom" ;;
            esac

            jq -r '
              paths(scalars) as $p |
              [($p | join(".")), (getpath($p))] |
              @tsv
            ' "$FILE" | while IFS=$'\t' read -r KEY VALUE; do
              SAFE_KEY=$(printf '%s' "$KEY" | sed 's/"/""/g')
              SAFE_VALUE=$(printf '%s' "$VALUE" | sed 's/"/""/g')
              echo "\"$REPO\",\"$TYPE\",\"$SAFE_KEY\",\"$SAFE_VALUE\"" >> sbomqs_summary.csv
            done
          done

      - name: Upload CSV summary
        uses: actions/upload-artifact@v4
        with:
          name: sbomqs_summary
          path: sbomqs_summary.csv
