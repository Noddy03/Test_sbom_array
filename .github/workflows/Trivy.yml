name: Top IoT Repos Trivy Scan

on:
  workflow_dispatch:
    inputs:
      language:
        description: 'Programming language to filter repos (e.g., Java, Python)'
        required: true
        default: 'Java'

jobs:
  fetch-and-scan:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Fetch top 100 IoT repos
        id: fetch
        run: |
          LANGUAGE="${{ github.event.inputs.language }}"
          echo "Fetching top 100 IoT repos for language: $LANGUAGE"

          REPOS=$(gh repo list --topic iot --language "$LANGUAGE" --limit 100 --json nameWithOwner,stargazerCount | \
                  jq -r 'sort_by(.stargazerCount) | reverse | .[].nameWithOwner')

          # Convert to JSON array for matrix
          MATRIX_JSON=$(printf '%s\n' "$REPOS" | jq -R . | jq -s '{repo: .}')
          echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT

      - name: Set matrix output
        id: set-matrix
        run: echo "matrix=${{ steps.fetch.outputs.matrix }}" >> $GITHUB_OUTPUT

  scan:
    needs: fetch-and-scan
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{fromJSON(needs.fetch-and-scan.outputs.matrix).repo}}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          repository: ${{ matrix }}
          path: repo

      - name: Run Trivy scan
        working-directory: repo
        run: |
          safe_name="${matrix//\//_}"  # replace slashes with underscore
          echo "Scanning repository: $matrix -> $safe_name.json"
          trivy fs --scanners vuln --timeout 15m --format json -o ../scan_${safe_name}.json .

      - name: Upload Trivy scan result
        uses: actions/upload-artifact@v3
        with:
          name: "trivy-scan-${{ matrix }}"
          path: "../scan_${matrix//\//_}.json"
