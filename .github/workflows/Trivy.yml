name: IOT_SBOM_SCA_Trivy

on:
  workflow_dispatch:
    inputs:
      language:
        description: "Language (e.g., Java, Python, C, C++, JS)"
        required: true
        default: "Java"

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      ############################################################
      # Cache Trivy DB (HUGE speed boost)
      ############################################################
      - name: Cache Trivy DB
        uses: actions/cache@v3
        with:
          path: ~/.cache/trivy
          key: trivy-db-cache

      ############################################################
      # Fetch IoT repos
      ############################################################
      - name: Fetch IoT Repos
        env:
          LANGUAGE: ${{ github.event.inputs.language }}
        run: |
          curl -s \
            "https://api.github.com/search/repositories?q=topic:iot+language:${LANGUAGE}&sort=stars&order=desc&per_page=100" \
            | jq -r '.items[].clone_url' > repos.txt
          echo "Found $(wc -l < repos.txt) repos."

      ############################################################
      # Install Trivy
      ############################################################
      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
            | sudo sh -s -- -b /usr/local/bin

      ############################################################
      # Prepare output
      ############################################################
      - name: Prepare Output
        run: |
          mkdir -p output
          echo "repo,sbom_components,sca_direct,sca_from_sbom,status" > output/summary.csv

      ############################################################
      # Process Each Repo
      ############################################################
      - name: Process Each Repo
        shell: bash
        run: |
          while IFS= read -r repo; do
            echo "========== Processing $repo =========="
            name=$(basename "$repo" .git)
            safe=$(echo "$name" | tr -cd 'A-Za-z0-9._-')

            ############################################################
            # Clone repo
            ############################################################
            if ! timeout 1200 git clone --depth 1 "$repo" "$safe"; then
              echo "$safe,0,0,0,clone_failed" >> output/summary.csv
              continue
            fi
            cd "$safe"

            ############################################################
            # SBOM generation (CycloneDX)
            ############################################################
            sbom_file="../output/${safe}_sbom.json"
            if timeout 1200 trivy sbom --format cyclonedx --output "$sbom_file" . ; then
              sbom_components=$(jq '.components | length // 0' "$sbom_file")
            else
              sbom_components=0
            fi

            ############################################################
            # Direct SCA scan (skip heavy dirs)
            ############################################################
            sca_file="../output/${safe}_sca_direct.json"
            if timeout 1200 trivy fs \
                  --skip-dirs node_modules \
                  --skip-dirs vendor \
                  --skip-dirs build \
                  --skip-dirs dist \
                  --skip-dirs target \
                  --skip-dirs .git \
                  --scanners vuln \
                  --format json \
                  --output "$sca_file" . ; then
              sca_direct=$(jq '[.Results[].Vulnerabilities // [] | length] | add // 0' "$sca_file")
            else
              sca_direct=0
            fi

            ############################################################
            # SCA using SBOM only
            ############################################################
            sbom_sca_file="../output/${safe}_sca_from_sbom.json"
            if [ -f "$sbom_file" ]; then
              if timeout 1200 trivy sbom \
                    --input "$sbom_file" \
                    --format json \
                    --output "$sbom_sca_file" ; then
                sca_from_sbom=$(jq '[.Results[].Vulnerabilities // [] | length] | add // 0' "$sbom_sca_file")
              else
                sca_from_sbom=0
              fi
            else
              sca_from_sbom=0
            fi

            ############################################################
            # Write summary entry
            ############################################################
            echo "$safe,$sbom_components,$sca_direct,$sca_from_sbom,success" >> ../output/summary.csv

            cd ..
            rm -rf "$safe"
          done < repos.txt

      ############################################################
      # Upload results
      ############################################################
      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: iot_sbom_sca_results
          path: output/
