name: IoT Repos Trivy Scan

on:
  workflow_dispatch:
    inputs:
      language:
        description: "Programming language to filter IoT repos"
        required: true
        default: "Java"

jobs:
  trivy-iot-scan:
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      MAX_REPOS: 100

    steps:
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl git coreutils

      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
            | sudo sh -s -- -b /usr/local/bin

      - name: Preload Trivy DB once
        run: |
          trivy db --download-db-only
          echo "Trivy DB preloaded."

      - name: Search Top IoT Repos
        id: fetch_repos
        run: |
          LANGUAGE="${{ github.event.inputs.language }}"
          echo "Searching IoT repos in language: $LANGUAGE"

          curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/search/repositories?q=topic:iot+language:$LANGUAGE&sort=stars&order=desc&per_page=100" \
            | jq -r '.items[].clone_url' > repos.txt

          echo "Found $(wc -l < repos.txt) repositories."
          echo "repos=$(cat repos.txt | jq -R -s -c 'split("\n")[:-1]')" >> $GITHUB_ENV

      - name: Scan each repo with Trivy (fast + stable)
        run: |
          mkdir -p output
          echo "repo,sbom_components,sca_direct,sca_sbom,status" > output/summary.csv

          while read repo; do
            echo "==== Processing $repo ===="

            name=$(basename "$repo" .git)
            safe="${name//\//_}"

            # Clone repo (timeout 2 minutes)
            if ! timeout 120 git clone --depth 1 "$repo" "$safe"; then
              echo "$safe,0,0,0,clone_failed" >> output/summary.csv
              continue
            fi

            cd "$safe"

            # SBOM generation
            sbom_file="../output/${safe}_sbom.json"
            if timeout 60 trivy fs \
                --skip-db-update \
                --format cyclonedx \
                --skip-dirs .git \
                --skip-dirs build \
                --skip-dirs out \
                --skip-dirs dist \
                --skip-dirs vendor \
                --skip-dirs node_modules \
                --no-progress \
                --output "$sbom_file" . ; then
              sbom_components=$(jq '.components | length' "$sbom_file" 2>/dev/null || echo 0)
            else
              sbom_components=0
            fi

            # Direct SCA
            sca_file="../output/${safe}_sca_direct.json"
            if timeout 60 trivy fs \
                --skip-db-update \
                --format json \
                --skip-dirs .git \
                --skip-dirs build \
                --skip-dirs out \
                --skip-dirs dist \
                --skip-dirs vendor \
                --skip-dirs node_modules \
                --no-progress \
                --output "$sca_file" . ; then
              sca_direct=$(jq '[.Results[].Vulnerabilities | length] | add' "$sca_file" 2>/dev/null || echo 0)
            else
              sca_direct=0
            fi

            # SBOM SCA
            sbom_sca_file="../output/${safe}_sca_sbom.json"
            if timeout 30 trivy sbom \
                --skip-db-update \
                --input "$sbom_file" \
                --format json \
                --no-progress \
                --output "$sbom_sca_file"; then
              sca_sbom=$(jq '[.Results[].Vulnerabilities | length] | add' "$sbom_sca_file" 2>/dev/null || echo 0)
            else
              sca_sbom=0
            fi

            echo "$safe,$sbom_components,$sca_direct,$sca_sbom,success" >> ../output/summary.csv

            cd ..
            rm -rf "$safe"

          done < repos.txt

      - name: Upload SBOM + SCA artifacts and summary
        uses: actions/upload-artifact@v4
        with:
          name: iot-sbom-sca
          path: output/
