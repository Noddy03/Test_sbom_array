name: Top IoT Repos Trivy Scan

on:
  workflow_dispatch:
    inputs:
      language:
        description: 'Programming language to filter repositories (e.g., Java, Python)'
        required: true
        default: 'Java'

jobs:
  fetch-and-scan:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up GitHub CLI
        uses: cli/cli-action@v2

      - name: Fetch top 100 IoT repos
        id: fetch-repos
        run: |
          echo "Fetching top 100 IoT repos for language: ${{ github.event.inputs.language }}"
          repos=$(gh search repos "topic:IoT language:${{ github.event.inputs.language }}" --sort stars --limit 100 --json name,url -q '.[].url')
          echo "repos=$repos" >> $GITHUB_OUTPUT

      - name: Prepare matrix
        id: set-matrix
        run: |
          # Convert newline-separated list to JSON array
          echo "::set-output name=matrix::$(echo '${{ steps.fetch-repos.outputs.repos }}' | jq -R -s -c 'split("\n")[:-1]')"

  scan:
    needs: fetch-and-scan
    runs-on: ubuntu-latest
    strategy:
      matrix:
        repo: ${{ fromJSON(needs.fetch-and-scan.outputs.matrix) }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          repository: ${{ matrix.repo }}
          fetch-depth: 0

      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh

      - name: Run Trivy scan
        run: |
          mkdir -p scan
          trivy fs --scanners vuln,secret --format json -o scan/scan-results.json .

      - name: Upload individual scan results
        uses: actions/upload-artifact@v3
        with:
          name: trivy-scan-${{ matrix.repo }}
          path: scan/scan-results.json

  merge-and-upload:
    needs: scan
    runs-on: ubuntu-latest
    steps:
      - name: Download all scan results
        uses: actions/download-artifact@v3
        with:
          path: all-scans

      - name: Merge scan results into pastry_summary.json
        run: |
          mkdir merged
          cp all-scans/*/* scan
          jq -s '.' all-scans/*/* > pastry_summary.json

      - name: Upload pastry_summary
        uses: actions/upload-artifact@v3
        with:
          name: pastry_summary
          path: pastry_summary.json
