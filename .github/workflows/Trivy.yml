name: Top IoT Repos Trivy Scan

on:
  workflow_dispatch:
    inputs:
      language:
        description: 'Programming language to filter repos'
        required: true
        default: 'java'
      max_repos:
        description: 'Number of repos to fetch'
        required: false
        default: 100

jobs:
  fetch-and-scan:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Set up GitHub CLI
        uses: cli/gh-action@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch top IoT repos
        id: fetch-repos
        run: |
          echo "Fetching top ${{ github.event.inputs.max_repos }} repos in language ${{ github.event.inputs.language }}"
          REPOS=$(gh repo list --topic iot --language ${{ github.event.inputs.language }} --limit ${{ github.event.inputs.max_repos }} --sort stars --json nameWithOwner | jq -r '.[].nameWithOwner')
          MATRIX_JSON=$(jq -n --argjson repos "$(echo "$REPOS" | jq -R -s -c 'split("\n")[:-1]')" '{"include": $repos | map({repo: .})}')
          echo "$MATRIX_JSON" > matrix.json
          echo "matrix=$(cat matrix.json)" >> "$GITHUB_OUTPUT"

      - name: Set matrix output
        id: set-matrix
        run: |
          echo "matrix=$(cat matrix.json)" >> "$GITHUB_OUTPUT"

  scan:
    needs: fetch-and-scan
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{fromJSON(needs.fetch-and-scan.outputs.matrix).include}}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          repository: ${{ matrix.repo }}
          path: repo

      - name: Install Trivy
        run: |
          sudo apt-get update && sudo apt-get install -y wget
          wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.68.0_Linux-64bit.deb
          sudo dpkg -i trivy_0.68.0_Linux-64bit.deb

      - name: Run Trivy scan
        working-directory: repo
        run: |
          trivy fs --scanners vuln,secret --timeout 30m -f json -o ../output_${{ matrix.repo//\//_ }}.json .

      - name: Upload Trivy JSON
        uses: actions/upload-artifact@v3
        with:
          name: trivy-report-${{ matrix.repo//\//_ }}
          path: ../output_${{ matrix.repo//\//_ }}.json
