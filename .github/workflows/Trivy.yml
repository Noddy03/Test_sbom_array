name: IoT Repos SBOM + SCA with Trivy

on:
  workflow_dispatch:
    inputs:
      language:
        description: "Programming language filter"
        required: true
        default: "Java"

jobs:
  trivy-iot-scan:
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      MAX_REPOS: 100

    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl git coreutils

      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
          trivy --version

      - name: Warm Trivy DB (required workaround)
        run: |
          echo "Triggering one dummy scan to download DB..."
          trivy image --debug alpine:latest || true

      - name: Search Top IoT Repos
        id: fetch_repos
        run: |
          LANGUAGE="${{ github.event.inputs.language }}"
          curl -s -H "Authorization: token $GITHUB_TOKEN" \
          "https://api.github.com/search/repositories?q=topic:iot+language:$LANGUAGE&sort=stars&order=desc&per_page=100" \
          | jq -r '.items[].clone_url' | head -n $MAX_REPOS > repos.txt
          echo "Found $(wc -l < repos.txt) repositories"

      - name: Loop Over Repos â€” SBOM + SCA
        run: |
          mkdir -p output
          echo "repo,deps,vulns,status" > output/summary.csv

          while read repo; do
            echo "-----------------------------------"
            echo "Processing $repo"
            name=$(basename "$repo" .git)

            # Clone with timeout
            if ! timeout 600 git clone --depth 1 "$repo" "$name"; then
              echo "$name,0,0,clone_timeout" >> output/summary.csv
              continue
            fi

            cd "$name"

            # SBOM generation (CycloneDX)
            if ! timeout 600 trivy sbom . --format cyclonedx --output "../output/${name}_sbom.json"; then
              echo "$name,0,0,sbom_timeout" >> ../output/summary.csv
              cd ..
              rm -rf "$name"
              continue
            fi

            deps=$(jq '.components | length' "../output/${name}_sbom.json" 2>/dev/null || echo 0)

            # Vulnerability scan from SBOM
            if timeout 600 trivy sbom "../output/${name}_sbom.json" --format json --output "../output/${name}_sca.json"; then
              vulns=$(jq '.Results[].Vulnerabilities | length' "../output/${name}_sca.json" 2>/dev/null | paste -sd+ - | bc || echo 0)
            else
              vulns=0
            fi

            echo "$name,$deps,$vulns,success" >> ../output/summary.csv

            cd ..
            rm -rf "$name"
          done < repos.txt

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: trivy-iot-sbom-sca
          path: output/
