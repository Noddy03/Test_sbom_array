name: Security Scan â€“ Trivy SCA + SBOM + OSV + Deduplicated CVEs

on:
  workflow_dispatch:
    inputs:
      language:
        description: 'Choose language to scan'
        required: true
        default: 'Java'
      top_n:
        description: 'Number of repositories to scan'
        required: false
        default: '5'

permissions:
  contents: read
  security-events: write

jobs:
# =========================================================
# FETCH REPOSITORIES
# =========================================================
  fetch_repos:
    runs-on: ubuntu-latest
    outputs:
      repos: ${{ steps.fetch.outputs.repos }}
    steps:
      - id: fetch
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          LANG: ${{ inputs.language }}
          TOP_N: ${{ inputs.top_n }}
        run: |
          python3 <<'EOF'
          import os, requests, json, urllib.parse, time
          headers = {"Authorization": f"token {os.environ['TOKEN']}"}
          repos=[]
          page=1
          while len(repos)<int(os.environ["TOP_N"]) and page<=10:
            url=f"https://api.github.com/search/repositories?q=language:{urllib.parse.quote(os.environ['LANG'])}&sort=stars&order=desc&page={page}"
            r=requests.get(url,headers=headers)
            for repo in r.json().get("items",[]):
              repos.append(repo["full_name"])
              if len(repos)>=int(os.environ["TOP_N"]): break
            page+=1
            time.sleep(1)
          with open(os.environ["GITHUB_OUTPUT"],"a") as f:
            f.write(f"repos={json.dumps(repos)}\n")
          EOF

# =========================================================
# SCAN EACH REPO
# =========================================================
  scan_repo:
    needs: fetch_repos
    runs-on: ubuntu-latest
    strategy:
      matrix:
        repo: ${{ fromJSON(needs.fetch_repos.outputs.repos) }}

    steps:
    - name: Install tools
      run: |
        sudo apt-get update
        sudo apt-get install -y jq git curl openjdk-17-jdk maven python3-pip
        curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh
        go install github.com/google/osv-scanner/cmd/osv-scanner@v1.9.0
        echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

    - name: Clone repo
      run: git clone --depth 1 https://github.com/${{ matrix.repo }} project

    # ---------------- SCA ----------------
    - name: Trivy SCA
      run: |
        mkdir -p results
        trivy fs project --scanners vuln --format json --output results/trivy_sca.json || echo '{"Results":[]}' > results/trivy_sca.json

    # ---------------- SBOM ----------------
    - name: Trivy SBOM
      run: |
        trivy fs project --format cyclonedx --output results/sbom.cdx.json || true
        trivy fs project --format json --output results/sbom_vuln.json || true

    # ---------------- OSV ----------------
    - name: OSV scan
      run: |
        osv-scanner -r project --format json > results/osv.json || echo '{"results":[]}' > results/osv.json

    # ---------------- UNIQUE CVEs ----------------
    - name: Deduplicate CVEs
      run: |
        mkdir -p results
        jq -r '.Results[].Vulnerabilities[].VulnerabilityID' results/trivy_sca.json | sort -u > results/trivy_unique_cves.txt
        jq -r '.results[].packages[].vulnerabilities[].id' results/osv.json | sort -u > results/osv_unique_cves.txt
        cat results/trivy_unique_cves.txt results/osv_unique_cves.txt | sort -u > results/all_unique_cves.txt
        wc -l results/all_unique_cves.txt > results/unique_cve_count.txt

    # ---------------- SEVERITY NORMALIZATION ----------------
    - name: OSV severity normalization
      run: |
        jq -r '
        .results[].packages[].vulnerabilities[] |
        (.severity[]?.score // 0 | tonumber) as $s |
        if $s < 4 then "LOW"
        elif $s < 7 then "MEDIUM"
        elif $s < 9 then "HIGH"
        else "CRITICAL" end
        ' results/osv.json | sort | uniq -c > results/osv_severity_counts.txt

    - name: Set artifact name
      id: set_artifact
      run: |
        SAFE_NAME=$(echo "${{ matrix.repo }}" | tr '/' '_')
        echo "name=$SAFE_NAME" >> $GITHUB_OUTPUT
    
    - uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.set_artifact.outputs.name }}
        path: results


# =========================================================
# SUMMARY
# =========================================================
  summarize:
    needs: scan_repo
    runs-on: ubuntu-latest
    steps:
    - uses: actions/download-artifact@v4
      with:
        path: all_results

    - name: Build summary.csv
      run: |
        echo "repo,\
        sca_low,sca_medium,sca_high,sca_critical,\
        sbom_low,sbom_medium,sbom_high,sbom_critical,\
        unique_cves" > summary.csv
        
            for d in all_results/*; do
              R=$(basename "$d")
        # -------- SCA (Trivy) --------
        SCAL=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="LOW")] | length' "$d/trivy_sca.json" 2>/dev/null || echo 0)
        SCAM=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' "$d/trivy_sca.json" 2>/dev/null || echo 0)
        SCAH=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="HIGH")] | length' "$d/trivy_sca.json" 2>/dev/null || echo 0)
        SCAC=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' "$d/trivy_sca.json" 2>/dev/null || echo 0)
        # -------- SBOM (OSV normalized) --------
        SB_L=$(grep LOW "$d/osv_severity_counts.txt" | awk '{print $1}' || echo 0)
        SB_M=$(grep MEDIUM "$d/osv_severity_counts.txt" | awk '{print $1}' || echo 0)
        SB_H=$(grep HIGH "$d/osv_severity_counts.txt" | awk '{print $1}' || echo 0)
        SB_C=$(grep CRITICAL "$d/osv_severity_counts.txt" | awk '{print $1}' || echo 0)
        # -------- Unique CVEs --------
        UNIQUE=$(cat "$d/unique_cve_count.txt" | awk '{print $1}')  
        echo "$R,$SCAL,$SCAM,$SCAH,$SCAC,$SB_L,$SB_M,$SB_H,$SB_C,$UNIQUE" >> summary.csv
        done


    - uses: actions/upload-artifact@v4
      with:
        name: summary
        path: summary.csv
