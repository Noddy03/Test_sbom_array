name: Top Repos Security Scan (SBOM Filtered)

on:
  workflow_dispatch:
    inputs:
      language:
        description: "Programming language to filter repos"
        required: true
        default: "Java"
      top_n:
        description: "Number of top repositories to scan"
        required: false
        default: "20"

permissions:
  contents: read
  security-events: write

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq git npm maven
          pip install requests semgrep
          npm install -g snyk

      - name: Fetch top N repositories
        id: fetch
        env:
          LANG_FILTER: ${{ inputs.language }}
          TOP_N: ${{ inputs.top_n }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python <<'EOF'
          import os, requests, urllib.parse
          lang = os.environ["LANG_FILTER"]
          top_n = int(os.environ["TOP_N"])
          token = os.environ["GITHUB_TOKEN"]
          headers = {"Authorization": f"token {token}"}
          q = urllib.parse.quote(f"language:{lang}")
          url = f"https://api.github.com/search/repositories?q={q}&sort=stars&order=desc&per_page={top_n}"
          r = requests.get(url, headers=headers)
          r.raise_for_status()
          repos = [item["full_name"] for item in r.json()["items"]]
          with open(os.environ["GITHUB_OUTPUT"], "a") as gh:
              gh.write(f"repos={','.join(repos)}\n")
          EOF

      - name: Detect SBOM repos
        id: filter
        env:
          REPOS: ${{ steps.fetch.outputs.repos }}
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir sbom-check
          SBOM_REPOS=""
          SBOM_PATTERNS="bom cyclonedx sbom spdx"
          IFS=',' read -ra REPO_ARRAY <<< "$REPOS"

          for repo in "${REPO_ARRAY[@]}"; do
              echo "Checking SBOM in $repo"
              git clone --depth 1 https://x-access-token:${TOKEN}@github.com/$repo sbom-check/$repo || continue
              cd sbom-check/$repo

              FILES=$(find . -type f \( -iname "*.json" -o -iname "*.xml" -o -iname "*.spdx" \) 2>/dev/null)
              HIT=0
              for f in $FILES; do
                for p in $SBOM_PATTERNS; do
                  if echo "$f" | grep -qi "$p"; then HIT=1; fi
                done
              done

              if [ $HIT -eq 1 ]; then
                echo "→ SBOM FOUND in $repo"
                SBOM_REPOS="$SBOM_REPOS,$repo"
              else
                echo "→ No SBOM"
              fi

              cd ../../
          done

          TEST_REPOS="snyk/test-vulnerabilities-java,snyk/test-vulnerabilities-node"
          FINAL_LIST="${SBOM_REPOS#,},$TEST_REPOS"
          echo "filtered=$FINAL_LIST" >> $GITHUB_OUTPUT

      - name: Prepare summary.csv
        run: |
          echo "repo,sca_low,sca_medium,sca_high,sca_critical,sast_low,sast_medium,sast_high,sast_critical,semgrep_low,semgrep_medium,semgrep_high,semgrep_critical,sbom_low,sbom_medium,sbom_high,sbom_critical,total" > summary.csv

      - name: Scan repositories
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          IFS=',' read -ra REPOS <<< "${{ steps.filter.outputs.filtered }}"

          for repo in "${REPOS[@]}"; do
            echo "=== SCANNING $repo ==="

            git clone --depth 1 https://x-access-token:${TOKEN}@github.com/$repo project || continue
            cd project

            if [ -f pom.xml ]; then mvn -B install -DskipTests || true; fi
            if [ -f package.json ]; then npm ci || npm install || true; fi
            if [ -f requirements.txt ]; then pip install -r requirements.txt || true; fi

            # Security scans with safe fallbacks
            snyk test --json > ../sca.json || { echo '{"vulnerabilities":[]}' > ../sca.json; }
            snyk code test --sarif > ../sast.sarif || { echo '{"runs":[]}' > ../sast.sarif; }
            semgrep --config p/ci --json > ../semgrep.json || { echo '{"results":[]}' > ../semgrep.json; }

            cd ..

            # ---------------- SCA ----------------
            SCA_L=$(jq '[.vulnerabilities[] | select(.severity=="low")] | length' sca.json)
            SCA_M=$(jq '[.vulnerabilities[] | select(.severity=="medium")] | length' sca.json)
            SCA_H=$(jq '[.vulnerabilities[] | select(.severity=="high")] | length' sca.json)
            SCA_C=$(jq '[.vulnerabilities[] | select(.severity=="critical")] | length' sca.json)

            # ---------------- SAST --------------
            SAST_L=$(jq '[.runs[].results[] | select(.level=="note")] | length' sast.sarif)
            SAST_M=$(jq '[.runs[].results[] | select(.level=="warning")] | length' sast.sarif)
            SAST_H=$(jq '[.runs[].results[] | select(.level=="error")] | length' sast.sarif)
            SAST_C=$(jq '[.runs[].results[] | select(.ruleId | test("critical"))] | length' sast.sarif)

            # ---------------- Semgrep ----------
            SEM_L=$(jq '[.results[] | select(.extra.level=="INFO")] | length' semgrep.json)
            SEM_M=$(jq '[.results[] | select(.extra.level=="WARNING")] | length' semgrep.json)
            SEM_H=$(jq '[.results[] | select(.extra.level=="ERROR")] | length' semgrep.json)
            SEM_C=$(jq '[.results[] | select(.check_id | test("critical|sql|xss|injection"))] | length' semgrep.json)

            # ---------------- SBOM parsing -------
            SBOM_L=0
            SBOM_M=0
            SBOM_H=0
            SBOM_C=0

            SBOM_FILES=$(find project -type f \( -iname "*bom*.json" -o -iname "*cyclonedx*.json" -o -iname "*.cdx.json" -o -iname "*.spdx.json" -o -iname "*.spdx" \) 2>/dev/null)

            for sbom in $SBOM_FILES; do
                echo "Parsing SBOM: $sbom"

                # CycloneDX
                if jq -e '.vulnerabilities' "$sbom" >/dev/null 2>&1; then
                    SBOM_L=$((SBOM_L + $(jq '[.vulnerabilities[] | select(.ratings[].severity=="low")] | length' "$sbom")))
                    SBOM_M=$((SBOM_M + $(jq '[.vulnerabilities[] | select(.ratings[].severity=="medium")] | length' "$sbom")))
                    SBOM_H=$((SBOM_H + $(jq '[.vulnerabilities[] | select(.ratings[].severity=="high")] | length' "$sbom")))
                    SBOM_C=$((SBOM_C + $(jq '[.vulnerabilities[] | select(.ratings[].severity=="critical")] | length' "$sbom")))
                fi

                # SPDX (security refs) - SAFE version
                if jq -e '.packages' "$sbom" >/dev/null 2>&1; then
                    SBOM_H=$((SBOM_H + $(jq '[.packages[] | select((.externalRefs // []) | map(.referenceCategory=="SECURITY") | any)] | length' "$sbom")))
                fi
            done

            TOTAL=$((SCA_L+SCA_M+SCA_H+SCA_C + SAST_L+SAST_M+SAST_H+SAST_C + SEM_L+SEM_M+SEM_H+SEM_C + SBOM_L+SBOM_M+SBOM_H+SBOM_C))

            echo "\"$repo\",$SCA_L,$SCA_M,$SCA_H,$SCA_C,$SAST_L,$SAST_M,$SAST_H,$SAST_C,$SEM_L,$SEM_M,$SEM_H,$SEM_C,$SBOM_L,$SBOM_M,$SBOM_H,$SBOM_C,$TOTAL" >> summary.csv

            rm -rf project

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: security-summary
          path: summary.csv
