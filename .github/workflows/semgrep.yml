name: Test Dispatch Workflow

on:
  workflow_dispatch:
    inputs:
      language:
        description: "Programming language"
        required: true
        default: "Java"
      top_n:
        description: "Number of top repos"
        required: false
        default: "3"

jobs:
  fetch_repos:
    runs-on: ubuntu-latest
    outputs:
      repo_list: ${{ steps.collect.outputs.repo_list }}
    steps:
      - name: Install Python
        run: pip install requests
      - name: Fetch repos
        id: collect
        env:
          INPUT_LANGUAGE: ${{ inputs.language }}
          INPUT_TOP_N: ${{ inputs.top_n }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python <<'EOF'
          import os, requests, json

          lang = os.environ["INPUT_LANGUAGE"]
          top_n = int(os.environ["INPUT_TOP_N"])
          token = os.environ["GITHUB_TOKEN"]

          url = f"https://api.github.com/search/repositories?q=language:{lang}&sort=stars&order=desc&per_page={top_n}"
          r = requests.get(url, headers={"Authorization": f"token {token}"})
          r.raise_for_status()
          repos = [item["full_name"] for item in r.json().get("items", [])]
          if not repos:
              repos = ["snyk/test-vulnerabilities-java"]

          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"repo_list={json.dumps(repos)}\n")
          EOF

  scan_repos:
    needs: fetch_repos
    runs-on: ubuntu-latest
    strategy:
      matrix:
        repo: ${{ fromJson(needs.fetch_repos.outputs.repo_list) }}
    steps:
      - name: Show repo
        run: echo "Scanning ${{ matrix.repo }}"
