name: Top Repos Security Scan faster (SBOM Filtered)

on:
  workflow_dispatch:
    inputs:
      language:
        description: "Programming language to filter repos"
        required: true
        default: "Java"
      top_n:
        description: "Number of top repositories to scan"
        required: false
        default: "5"

permissions:
  contents: read
  security-events: write

jobs:
  fetch_repos:
    runs-on: ubuntu-latest
    outputs:
      repos: ${{ steps.set_output.outputs.repos }}
    steps:
      - name: Install Python and git
        run: sudo apt-get update && sudo apt-get install -y python3 python3-pip git

      - name: Fetch top N repositories with SBOM
        id: set_output
        env:
          LANG_FILTER: ${{ inputs.language }}
          TOP_N: ${{ inputs.top_n }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 <<'EOF'
          import os, requests, urllib.parse, subprocess, tempfile, shutil, json
          lang = os.environ["LANG_FILTER"]
          top_n = int(os.environ["TOP_N"])
          token = os.environ["GITHUB_TOKEN"]
          headers = {"Authorization": f"token {token}"}
          q = urllib.parse.quote(f"language:{lang}")
          url = f"https://api.github.com/search/repositories?q={q}&sort=stars&order=desc&per_page=100"
          r = requests.get(url, headers=headers)
          r.raise_for_status()
          items = r.json()["items"]
          selected_repos = []
          for repo in items:
              if len(selected_repos) >= top_n:
                  break
              full_name = repo["full_name"]
              tmpdir = tempfile.mkdtemp()
              try:
                  result = subprocess.run(
                      ["git", "clone", "--depth", "1", f"https://x-access-token:{token}@github.com/{full_name}", tmpdir],
                      stdout=subprocess.PIPE, stderr=subprocess.PIPE
                  )
                  if result.returncode != 0:
                      continue
                  # Search for SBOM files
                  sbom_files = subprocess.run(
                      ["find", tmpdir, "-type", "f",
                       "-iname", "*bom*.json", "-o", "-iname", "*bom*.xml",
                       "-o", "-iname", "*cyclonedx*.json", "-o", "-iname", "*cyclonedx*.xml",
                       "-o", "-iname", "*.cdx.json", "-o", "-iname", "*.spdx.json", "-o", "-iname", "*.spdx"],
                      stdout=subprocess.PIPE
                  ).stdout.decode().strip()
                  if sbom_files:
                      selected_repos.append(full_name)
              finally:
                  shutil.rmtree(tmpdir)
          with open(os.environ["GITHUB_OUTPUT"], "a") as gh:
              gh.write(f"repos={json.dumps(selected_repos or [])}\n")
          EOF

  scan_repo:
    needs: fetch_repos
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        repo: ${{ fromJSON(needs.fetch_repos.outputs.repos) }}
    continue-on-error: true
    steps:
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq git npm python3-pip
          pip3 install semgrep
          npm install -g snyk

      - name: Set safe repo name
        run: echo "SAFE_NAME=$(echo '${{ matrix.repo }}' | tr '/' '-')" >> $GITHUB_ENV

      - name: Clone repository safely
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p project
          git clone --depth 1 https://x-access-token:${TOKEN}@github.com/${{ matrix.repo }} project || exit 0

      - name: Run security scans
        run: |
          mkdir -p results
          cd project || exit 0
          snyk test --json > ../sca.json || echo '{"vulnerabilities":[]}' > ../sca.json
          snyk code test --sarif > ../sast.sarif || echo '{"runs":[]}' > ../sast.sarif
          semgrep --config p/ci --json > ../semgrep.json || echo '{"results":[]}' > ../semgrep.json
          cd ..

          mkdir -p results

          # SBOM counting in Python (JSON + XML support)
          python3 <<'EOF'
          import os, glob, json, xml.etree.ElementTree as ET
          
          sbom_counts = {"low": 0, "medium": 0, "high": 0, "critical": 0}
          
          sbom_files = glob.glob("project/**/*bom*.json", recursive=True) + \
                       glob.glob("project/**/*cyclonedx*.json", recursive=True) + \
                       glob.glob("project/**/*.cdx.json", recursive=True) + \
                       glob.glob("project/**/*.spdx.json", recursive=True) + \
                       glob.glob("project/**/*.spdx", recursive=True) + \
                       glob.glob("project/**/*bom*.xml", recursive=True) + \
                       glob.glob("project/**/*cyclonedx*.xml", recursive=True)
          
          for sbom in sbom_files:
              try:
                  if sbom.endswith((".json")):
                      with open(sbom, "r") as f:
                          data = json.load(f)
                      vulns = data.get("vulnerabilities", [])
                      for v in vulns:
                          for rating in v.get("ratings", []):
                              sev = rating.get("severity", "").lower()
                              if sev in sbom_counts:
                                  sbom_counts[sev] += 1
                  else:  # XML SBOM
                      tree = ET.parse(sbom)
                      root = tree.getroot()
                      for vuln in root.findall(".//vulnerability"):
                          sev = vuln.findtext("ratings/rating/severity")
                          if not sev:
                              sev = vuln.findtext("severity")
                          if sev:
                              sev = sev.lower()
                              if sev in sbom_counts:
                                  sbom_counts[sev] += 1
              except Exception as e:
                  print(f"Skipping {sbom} due to error: {e}")
          
          os.makedirs("results", exist_ok=True)
          with open("results/sbom_counts.txt", "w") as f:
              f.write(f"{sbom_counts['low']},{sbom_counts['medium']},{sbom_counts['high']},{sbom_counts['critical']}")
          EOF

          echo "${{ matrix.repo }}" > results/repo.txt
          cp sca.json results/
          cp sast.sarif results/
          cp semgrep.json results/

          mkdir -p all_results
          mv results all_results/$SAFE_NAME
          rm -rf project

      - name: Upload per-repo results
        uses: actions/upload-artifact@v4
        with:
          name: "repo-results-${{ github.run_id }}-${{ env.SAFE_NAME }}"
          path: all_results/${{ env.SAFE_NAME }}

  summarize:
    needs: scan_repo
    runs-on: ubuntu-latest
    steps:
      - name: Download all repo results
        uses: actions/download-artifact@v4
        with:
          path: all_results

      - name: Generate summary.csv
        run: |
          echo "repo,sca_low,sca_medium,sca_high,sca_critical,sast_low,sast_medium,sast_high,sast_critical,semgrep_low,semgrep_medium,semgrep_high,semgrep_critical,sbom_low,sbom_medium,sbom_high,sbom_critical,total" > summary.csv
          for d in all_results/*; do
            if [ -d "$d" ]; then
              repo=$(cat "$d/repo.txt")
              SCA_L=$(jq '[.vulnerabilities[] | select(.severity=="low")] | length' "$d/sca.json")
              SCA_M=$(jq '[.vulnerabilities[] | select(.severity=="medium")] | length' "$d/sca.json")
              SCA_H=$(jq '[.vulnerabilities[] | select(.severity=="high")] | length' "$d/sca.json")
              SCA_C=$(jq '[.vulnerabilities[] | select(.severity=="critical")] | length' "$d/sca.json")
              SAST_L=$(jq '[.runs[].results[] | select(.level=="note")] | length' "$d/sast.sarif")
              SAST_M=$(jq '[.runs[].results[] | select(.level=="warning")] | length' "$d/sast.sarif")
              SAST_H=$(jq '[.runs[].results[] | select(.level=="error")] | length' "$d/sast.sarif")
              SAST_C=$(jq '[.runs[].results[] | select(.ruleId | test("critical"))] | length' "$d/sast.sarif")
              SEM_L=$(jq '[.results[] | select(.extra.level=="INFO")] | length' "$d/semgrep.json")
              SEM_M=$(jq '[.results[] | select(.extra.level=="WARNING")] | length' "$d/semgrep.json")
              SEM_H=$(jq '[.results[] | select(.extra.level=="ERROR")] | length' "$d/semgrep.json")
              SEM_C=$(jq '[.results[] | select(.check_id | test("critical|sql|xss|injection"))] | length' "$d/semgrep.json")
              SBOM_L=$(cut -d',' -f1 "$d/sbom_counts.txt")
              SBOM_M=$(cut -d',' -f2 "$d/sbom_counts.txt")
              SBOM_H=$(cut -d',' -f3 "$d/sbom_counts.txt")
              SBOM_C=$(cut -d',' -f4 "$d/sbom_counts.txt")
              TOTAL=$((SCA_L+SCA_M+SCA_H+SCA_C+SAST_L+SAST_M+SAST_H+SAST_C+SEM_L+SEM_M+SEM_H+SEM_C+SBOM_L+SBOM_M+SBOM_H+SBOM_C))
              echo "\"$repo\",$SCA_L,$SCA_M,$SCA_H,$SCA_C,$SAST_L,$SAST_M,$SAST_H,$SAST_C,$SEM_L,$SEM_M,$SEM_H,$SEM_C,$SBOM_L,$SBOM_M,$SBOM_H,$SBOM_C,$TOTAL" >> summary.csv
            fi
          done

      - name: Upload summary
        uses: actions/upload-artifact@v4
        with:
          name: "security-summary-${{ github.run_id }}"
          path: summary.csv
