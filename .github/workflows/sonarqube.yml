name: Multi-Repo Static Analysis (Secretless SonarQube Replacement)

on:
  workflow_dispatch:
    inputs:
      language:
        description: "Language filter (C++, Python, Java, JavaScript)"
        required: true
        default: "C++"
      max_repos:
        description: "Max repositories to scan"
        required: true
        default: "25"

permissions:
  contents: read
  security-events: write

jobs:
  fetch_repos:
    runs-on: ubuntu-latest
    outputs:
      repos: ${{ steps.out.outputs.repos }}
    steps:
      - name: Install jq & gh
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq gh

      - id: out
        env:
          LANG: ${{ github.event.inputs.language }}
          LIMIT: ${{ github.event.inputs.max_repos }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          QUERY="topic:iot language:$LANG fork:false archived:false"
          PAGE=1
          COLLECT="[]"

          while [ $PAGE -le 10 ]; do
            PAGE_DATA=$(gh api -X GET /search/repositories \
              --raw-field q="$QUERY" \
              --raw-field sort=stars \
              --raw-field order=desc \
              --raw-field per_page=100 \
              --raw-field page=$PAGE \
              --jq '.items[].full_name' || true)

            if [ -z "$PAGE_DATA" ]; then break; fi

            COLLECT=$(printf "%s\n%s" "$COLLECT" "$PAGE_DATA" | jq -R -s -c '
              split("\n") | map(select(length>0))')

            COUNT=$(echo "$COLLECT" | jq 'length')
            if [ "$COUNT" -ge "$LIMIT" ]; then break; fi

            PAGE=$((PAGE+1))
          done

          echo "repos=$COLLECT" >> $GITHUB_OUTPUT

  static_scan:
    needs: fetch_repos
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        repo: ${{ fromJSON(needs.fetch_repos.outputs.repos) }}

    steps:
      - name: Checkout repository
        run: |
          git clone --depth 1 "https://github.com/${{ matrix.repo }}" project || true

      - name: Install tools
        run: |
          sudo apt-get install -y jq python3 python3-pip nodejs npm default-jre
          pip install semgrep bandit flake8 || true
          npm install -g eslint || true
          wget https://github.com/pmd/pmd/releases/latest/download/pmd-bin-6.55.0.zip
          unzip -q pmd-bin-6.55.0.zip

      - name: Run Semgrep
        run: |
          semgrep --config auto -o project/semgrep.sarif --sarif project || echo '{"runs":[]}' > project/semgrep.sarif

      - name: Run Bandit (Python)
        run: |
          bandit -r project -f sarif -o project/bandit.sarif || echo '{"runs":[]}' > project/bandit.sarif

      - name: Run ESLint (JS/TS)
        run: |
          eslint project -f json -o project/eslint.json || echo '{"runs":[]}' > project/eslint.json

      - name: Run Flake8 (Python)
        run: |
          flake8 project --format=json > project/flake8.json || echo '{}' > project/flake8.json

      - name: Run PMD (Java)
        run: |
          ./pmd-bin-*/bin/run.sh pmd -d project -R rulesets/java/quickstart.xml -f sarif -r project/pmd.sarif || echo '{"runs":[]}' > project/pmd.sarif

      - name: Create summary.csv
        run: |
          OUT=project/summary.csv
          echo "repo,semgrep,bandit,eslint,pmd,flake8" > $OUT

          S1=$(jq '[.runs[].results[]] | length' project/semgrep.sarif 2>/dev/null || echo 0)
          S2=$(jq '[.runs[].results[]] | length' project/bandit.sarif 2>/dev/null || echo 0)
          S3=$(jq '. | length' project/eslint.json 2>/dev/null || echo 0)
          S4=$(jq '[.runs[].results[]] | length' project/pmd.sarif 2>/dev/null || echo 0)
          S5=$(jq 'to_entries | length' project/flake8.json 2>/dev/null || echo 0)

          echo "\"${{ matrix.repo }}\",$S1,$S2,$S3,$S4,$S5" >> $OUT

      - name: Safe artifact name
        id: safe
        run: |
          SAFE=$(echo "${{ matrix.repo }}" | sed 's/[^A-Za-z0-9._-]/_/g')
          echo "safe=$SAFE" >> $GITHUB_OUTPUT

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.safe.outputs.safe }}-scan
          path: project/**

  aggregate:
    needs: static_scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: all_summaries

      - name: Build master_summary.csv
        run: |
          echo "repo,semgrep,bandit,eslint,pmd,flake8" > master_summary.csv
          for f in $(find all_summaries -name "summary.csv"); do
            tail -n +2 "$f" >> master_summary.csv
          done

      - uses: actions/upload-artifact@v4
        with:
          name: master_summary
          path: master_summary.csv
