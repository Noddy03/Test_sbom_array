name: Security Scan â€“ Snyk + Semgrep + Trivy SBOM + OWASP DepScan

on:
  workflow_dispatch:
    inputs:
      language:
        required: true
        type: choice
        options: [Python, Java]
        default: Java
      top_n:
        required: false
        default: "10"

permissions:
  contents: read

jobs:
################################################################################
# FETCH REPOSITORIES (LANGUAGE ONLY â€” NO FILTERING)
################################################################################
  fetch_repos:
    runs-on: ubuntu-latest
    outputs:
      repos: ${{ steps.fetch.outputs.repos }}
    steps:
      - id: fetch
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          LANG: ${{ inputs.language }}
          TOP_N: ${{ inputs.top_n }}
        run: |
          python3 <<'EOF'
          import os, requests, json, urllib.parse, time

          headers = {
              "Authorization": f"token {os.environ['TOKEN']}",
              "Accept": "application/vnd.github+json"
          }

          language = os.environ["LANG"].lower()
          top_n = int(os.environ["TOP_N"])

          repos = []
          page = 1

          while len(repos) < top_n and page <= 10:
              url = (
                  "https://api.github.com/search/repositories"
                  f"?q=language:{urllib.parse.quote(language)}"
                  "&sort=stars&order=desc&per_page=30&page=" + str(page)
              )
              r = requests.get(url, headers=headers)
              if r.status_code != 200:
                  print("GitHub API error:", r.status_code, r.text)
                  break

              for repo in r.json().get("items", []):
                  repos.append(repo["full_name"])
                  if len(repos) >= top_n:
                      break

              page += 1
              time.sleep(1)

          print("Fetched repos:", repos)

          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write("repos=" + json.dumps(repos) + "\n")
          EOF

################################################################################
# SCAN REPOSITORIES (SINGLE JOB, LOOP BASED â€” NO MATRIX)
################################################################################
  scan_repos:
    needs: fetch_repos
    runs-on: ubuntu-latest
    env:
      REPOS: ${{ needs.fetch_repos.outputs.repos }}

    steps:
      - name: Validate repos
        run: |
          echo "Repos received:"
          echo "$REPOS"
          if ! echo "$REPOS" | jq -e '. | length > 0' >/dev/null; then
            echo "âŒ No repositories to scan"
            exit 0
          fi

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq git curl unzip openjdk-17-jdk maven
          pip3 install --upgrade pip semgrep
          npm install -g snyk
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin
          curl -sSL -o dep-scan-cli.jar https://github.com/owasp-dep-scan/dep-scan/releases/latest/download/dep-scan-cli.jar

      - name: Scan loop
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_SECRET }}
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p all_results
          echo "$REPOS" | jq -r '.[]' | while read repo; do
            SAFE=$(echo "$repo" | tr '/' '-')
            DIR="all_results/repo-results-$SAFE"
            mkdir -p "$DIR"

            echo "ðŸ” Scanning $repo"

            git clone --depth 1 https://x-access-token:${TOKEN}@github.com/$repo project || continue
            cd project || continue

            #######################################
            # Detect project type
            #######################################
            IS_MAVEN=false
            IS_PYTHON=false

            [ -f pom.xml ] && IS_MAVEN=true
            [ -f requirements.txt ] || [ -f pyproject.toml ] && IS_PYTHON=true

            #######################################
            # Build (best effort)
            #######################################
            if $IS_MAVEN; then
              mvn -q -DskipTests package || true
            fi

            if $IS_PYTHON; then
              python3 -m pip install -r requirements.txt 2>/dev/null || true
            fi

            #######################################
            # SNYK SCA
            #######################################
            snyk test --all-projects --json > "$DIR/sca.json" || echo '{"vulnerabilities":[]}' > "$DIR/sca.json"

            #######################################
            # SEMGREP
            #######################################
            semgrep --config p/security-audit --config p/owasp-top-ten --json > "$DIR/semgrep.json" || echo '{"results":[]}' > "$DIR/semgrep.json"

            #######################################
            # TRIVY SBOM
            #######################################
            trivy fs . --format json --output "$DIR/trivy.json" || echo '{}' > "$DIR/trivy.json"

            #######################################
            # OWASP DEP-SCAN (JAVA ONLY)
            #######################################
            if $IS_MAVEN; then
              java -jar ../dep-scan-cli.jar --scan . --format json --output "$DIR/dep-scan.json" || echo '{}' > "$DIR/dep-scan.json"
            else
              echo '{}' > "$DIR/dep-scan.json"
            fi

            cd ..
            rm -rf project
          done

      - uses: actions/upload-artifact@v4
        with:
          name: scan-results
          path: all_results

################################################################################
# SUMMARY
################################################################################
  summarize:
    needs: scan_repos
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: scan-results
          path: all_results

      - name: Build summary.csv
        run: |
          echo "repo,sca_total,semgrep_total,trivy_total,depscan_total,total" > summary.csv
          shopt -s nullglob
          for d in all_results/repo-results-*; do
            R=$(basename "$d" | sed 's/^repo-results-//')
            SCA=$(jq '.vulnerabilities | length' "$d/sca.json")
            SEM=$(jq '.results | length' "$d/semgrep.json")
            TRI=$(jq '[.Results[].Vulnerabilities[]?] | length' "$d/trivy.json" 2>/dev/null || echo 0)
            DEP=$(jq '.vulnerabilities | length' "$d/dep-scan.json" 2>/dev/null || echo 0)
            TOTAL=$((SCA+SEM+TRI+DEP))
            echo "$R,$SCA,$SEM,$TRI,$DEP,$TOTAL" >> summary.csv
          done

      - uses: actions/upload-artifact@v4
        with:
          name: security-summary
          path: summary.csv
